<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>英雄联盟 LCK 比赛日历</title>
  <link href="https://unpkg.com/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://unpkg.com/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://unpkg.com/fullcalendar@6.1.8/locales-all.global.min.js"></script>
  <script src="https://unpkg.com/ical.js@1.4.0/build/ical.min.js"></script>
  <style>
    @media (orientation: landscape) {
      body {
        margin: 0 40px;
      }
      .fc-header-toolbar {
        flex-direction: row !important; /* 横屏时正常横排 */
        flex-wrap: nowrap !important;
      }
    }
    @media (orientation: portrait) {
      body {
        margin: 0;
      }
      .fc-header-toolbar {
        flex-direction: column !important; /* 竖屏时三行 */
        align-items: center;
      }
      .fc-toolbar-chunk {
        width: 100%;
        text-align: center;
        margin: 5px 0;
      }
    }
    body { 
      font-family: Arial, sans-serif; 
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .nav-buttons,
    h2,
    #calendar {
      width: 100%;
      box-sizing: border-box;
    }
    .nav-buttons {
      order: 1;
      padding: 10px 0;
    }
    h2 {
      order: 2;
      margin: 15px 0;
    }
    #calendar {
      order: 3;
      flex-grow: 1;
    }
    #calendar { 
      max-width: 100%; 
      margin: 0 auto; 
    }
    h2 {
      font-size: 1.2em;
      text-align: center;
    }
    .nav-buttons {
      text-align: center;
      margin: 10px 0;
    }
    .nav-buttons a {
      display: inline-block;
      padding: 10px 20px;
      margin: 5px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 5px;
    }
    .nav-buttons a:hover {
      background-color: #0056b3;
    }
    /* 今天日程的样式 */
    .fc-list-event-dot[data-date-today] {
      background-color: #28a745 !important;
    }
    .fc-list-event[data-date-today] {
      background-color: rgba(40, 167, 69, 0.1) !important;
    }
    /* 昨天日程的样式 */
    .fc-list-event-dot[data-date-yesterday] {
      background-color: #6c757d !important;
    }
    .fc-list-event[data-date-yesterday] {
      background-color: rgba(108, 117, 125, 0.1) !important;
    }
    /* 明天日程的样式 */
    .fc-list-event-dot[data-date-tomorrow] {
      background-color: #17a2b8 !important;
    }
    .fc-list-event[data-date-tomorrow] {
      background-color: rgba(23, 162, 184, 0.1) !important;
    }
  </style>
</head>
<body>
  <div class="nav-buttons">
    <a href="../">LPL 日历</a>
    <a href="./">LCK 日历</a>
  </div>
  <h2>⚔️ 英雄联盟 LCK 比赛日历</h2>
  <div id="calendar"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("初始化英雄联盟 LCK 比赛日历...");
      const calendarEl = document.getElementById('calendar');

      // 设置默认视图为 list7 (最近7天)
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'list7',
        locale: 'zh-cn',
        initialDate: new Date(),   // 全局保持今天
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listWeek,timeGridDay,list7'
        },
        // 切换视图时自动调整日期
        viewDidMount: function(arg) {
          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(today.getDate() - 1);

          if (arg.view.type === 'list7') {
            calendar.gotoDate(yesterday);
          } else {
            calendar.gotoDate(today);
          }
        },
        slotLabelFormat: {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        },
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listWeek,timeGridDay,list7'
        },
        height: 'auto', // 让日历高度自适应
        views: {
          list7: {
            type: 'list',
            duration: { days: 7 },
            buttonText: '最近7天'
          },
          dayGridMonth: {
            buttonText: '月'
          },
          timeGridWeek: {
            buttonText: '周'
          },
          listWeek: {
            buttonText: '列表周'
          },
          timeGridDay: {
            buttonText: '日'
          }
        },
        visibleRange: function(currentDate) {
          // 昨天到未来6天，一共7天
          const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() - 1);
          const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + 6);
          return { start: startDate, end: endDate };
        },
        // 自定义日期格式化
        dayHeaderContent: function(arg) {
          const today = new Date();
          // 获取日期部分进行比较，避免时区问题
          const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const headerDate = new Date(arg.date.getFullYear(), arg.date.getMonth(), arg.date.getDate());
          let text = arg.text;
          
          // 计算日期差值（以天为单位）
          const timeDiff = headerDate.getTime() - todayDate.getTime();
          const daysDiff = Math.round(timeDiff / (1000 * 60 * 60 * 24));
          
          if (daysDiff === 0) {
            text += ' [今天]';
          } else if (daysDiff === -1) {
            text += ' [昨天]';
          } else if (daysDiff === 1) {
            text += ' [明天]';
          }
          
          return {
            html: text
          };
        },
        // 为事件元素添加数据属性
        eventDidMount: function(arg) {
          const eventDate = new Date(arg.event.start);
          const today = new Date();
          
          // 获取日期部分进行比较，避免时区问题
          const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const eventDateOnly = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
          
          // 计算日期差值（以天为单位）
          const timeDiff = eventDateOnly.getTime() - todayDate.getTime();
          const daysDiff = Math.round(timeDiff / (1000 * 60 * 60 * 24));
          
          // 检查事件日期并添加相应的数据属性
          if (daysDiff === 0) {
            arg.el.setAttribute('data-date-today', '');
          } else if (daysDiff === -1) {
            arg.el.setAttribute('data-date-yesterday', '');
          } else if (daysDiff === 1) {
            arg.el.setAttribute('data-date-tomorrow', '');
          }
          
          return arg.el;
        }

      });

      calendar.render();

      const icsFiles = ['../calendarIOS-LCK.ics'];

      icsFiles.forEach(file => {
        fetch(file)
          .then(response => response.text())
          .then(data => {
            console.log(`ICS 文件 ${file} 已获取，开始解析...`);
            const jcalData = ICAL.parse(data);
            const comp = new ICAL.Component(jcalData);
            const vevents = comp.getAllSubcomponents('vevent');
            const events = vevents.map(vevent => {
              const e = new ICAL.Event(vevent);
              const startDate = e.startDate.toJSDate();
              
              // 添加数据属性用于样式区分
              const today = new Date();
              const yesterday = new Date(today);
              yesterday.setDate(yesterday.getDate() - 1);
              const tomorrow = new Date(today);
              tomorrow.setDate(tomorrow.getDate() + 1);
              
              let eventData = {
                title: e.summary,
                start: startDate,
                end: e.endDate ? e.endDate.toJSDate() : startDate,
                description: e.description
              };
              
              // 检查事件日期并添加相应的数据属性
              if (startDate.getDate() === today.getDate() &&
                  startDate.getMonth() === today.getMonth() &&
                  startDate.getFullYear() === today.getFullYear()) {
                eventData.extendedProps = { 'data-date': 'today' };
              } else if (startDate.getDate() === yesterday.getDate() &&
                         startDate.getMonth() === yesterday.getMonth() &&
                         startDate.getFullYear() === yesterday.getFullYear()) {
                eventData.extendedProps = { 'data-date': 'yesterday' };
              } else if (startDate.getDate() === tomorrow.getDate() &&
                         startDate.getMonth() === tomorrow.getMonth() &&
                         startDate.getFullYear() === tomorrow.getFullYear()) {
                eventData.extendedProps = { 'data-date': 'tomorrow' };
              }
              
              return eventData;
            });
            console.log(`从 ${file} 解析得到 ${events.length} 个比赛事件`);
            calendar.addEventSource(events);
          })
          .catch(err => console.error(`获取或解析 ${file} 失败:`, err));
      });
    });
  </script>
</body>
</html>